#!/bin/sh

set -e

MAJOR_REQ=0
MINOR_REQ=11
PATCH_REQ=4

SCRIPT_DIR="$(pwd)/scripts"

. "${SCRIPT_DIR}/log"
. "${SCRIPT_DIR}/install/system-dependencies"
. "${SCRIPT_DIR}/install/selene"
. "${SCRIPT_DIR}/install/lpeglabel"
. "${SCRIPT_DIR}/install/nerd-fonts"
. "${SCRIPT_DIR}/install/nvim"

main() {
    if [ "$1" = "--nerd-fonts" ]; then
        init_clone_process
        info "Cloning nerd-fonts in background."
    else
        info "Skipping nerd-fonts installation."
        info "Please install nerd-fonts 'https://github.com/ryanoasis/nerd-fonts'."
    fi

    if ! install_system_dependencies; then
        error "Stopping installation. Can't install system dependencies."
        exit 1
    fi
    if ! check_nvim_version; then
        error "Neovim version v0.11.4 or higher is required.\n
        Please install it before you can continue with the installation."
        exit 1
    fi

    if ! install_selene; then
        warning "Can not install selene. Continue ..."
    fi

    if ! install_lpeglabel; then
        warning "Can not install lpeglabel. Continue ..."
    fi

    nvim --headless "+Lazy! sync" +qa

    info "Installing language-servers, formaters and linters ... "
    PATH="${CARGO_HOME:-$HOME/.cargo}/bin:$PATH" nvim --headless "+InitNVIM" +qa

    if [ "$1" = "--nerd-fonts" ]; then
        install_nerd_fonts
    fi

    info "You need to set a '${CARGO_HOME}/bin' in your path permanently to enable mason future updates."
    success "Setup nvim successfully. Enjoy it :)"
    return 0
}

main "$@"
