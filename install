#!/bin/sh

set -e

. ./scripts/log
. ./scripts/install-system-dependencies
. ./scripts/install-selene
. ./scripts/install-lpeglabel

check_nvim_version() {
    NVIM_VERSION_INFO=$(nvim --version 2>/dev/null | head -n1 | sed -E 's/^NVIM v([0-9]+\.[0-9]+(\.[0-9]+)?).*/\1/')

    IFS="." read -r MAJOR MINOR PATCH <<EOF
$NVIM_VERSION_INFO
EOF

    debug "Install nvim version is ${NVIM_VERSION_INFO}"

    if [ "$MAJOR" -lt 0 ] || [ "$MINOR" -lt 11 ] || [ "$PATCH" -lt 4 ]; then
        error "Neovim version is to low. Cancel installation"
        return 1
    fi
    return 0
}

main() {
    if [ "$1" = "--nerd-fonts" ]; then
        init_clone_process
        info "Cloning nerd-fonts in background."
    else
        info "Skipping nerd-fonts installation."
        info "Please install nerd-fonts 'https://github.com/ryanoasis/nerd-fonts'."
    fi

    if ! install_system_dependencies; then
        error "Stopping installation. Can't install system dependencies."
        exit 1
    fi
    if ! check_nvim_version; then
        exit 1
    fi

    if ! install_selene; then
        warning "Can not install selene. Continue ..."
    fi

    if ! install_lpeglabel; then
        warning "Can not install lpeglabel. Continue ..."
    fi

    info "Installing lazy..."
    nvim --headless +qa

    info "Installing plugins ... "
    nvim --headless "+Lazy! sync" +qa

    if [ "$1" = "--nerd-fonts" ]; then
        install_nerd_fonts
    fi

    info "Setup nvim successfully. Enjoy it :)"
    return 0
}

main "$@"
