#!/usr/bin/bash

BASH_TESTS_DIR="${NVIM_CONFIG}/tests/bash"

BASH_TEST_FILES=()
COUNTER_SUCCESS_TESTS=()
COUNTER_FAILURE_TESTS=()

function get_bash_test_files() {
    local content=""
    local regex=""
    content="$(cd "${BASH_TESTS_DIR}" && ls -l test_*.bats)"
    regex="^.*(test_.*\.bats)$"
    while IFS= read -r line; do
        if [[ ${line} =~ ${regex} ]]; then
            BASH_TEST_FILES+=("${BASH_REMATCH[1]}")
        fi
    done <<<"${content}"
}

function execute_bash_tests() {
    for test in "${BASH_TEST_FILES[@]}"; do
        output=$(bats "${BASH_TESTS_DIR}/${test}")
        status="$?"
        count_tests "${output}"
        if [ ${status} -ne 0 ]; then
            printf "%s" "${status}"
        fi
    done
}

function count_tests() {
    output=$1
    regex_success="^(ok [1-9]+ ).*$"
    regex_failure="^(not ok [1-9]+ ).*$"
    local counter_success=0
    local counter_failure=0
    while IFS= read -r line; do
        if [[ ${line} =~ ${regex_success} ]]; then
            ((counter_success++))
        elif [[ ${line} =~ ${regex_failure} ]]; then
            ((counter_failure++))
        fi
    done <<<"${output}"
    COUNTER_SUCCESS_TESTS+=(counter_success)
    COUNTER_FAILURE_TESTS+=(counter_failure)
}

get_bash_test_files
execute_bash_tests
